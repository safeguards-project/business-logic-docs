# customer_orders_pipeline.py

**File:** `../source-code/src/pyspark/customer_orders_pipeline.py`

---

## load_accounts

### Signature
```python
def load_accounts(path: str) -> DataFrame
```

### Description
Load account data from CSV file.
        
        BUSINESS_RULE: ACCOUNT_DATA_LOADING
        Account data is loaded with schema validation. Accounts define customer
        information and their order_limit for monthly order cap enforcement.
        
        Args:
            path: Path to accounts CSV file
            
        Returns:
            DataFrame containing validated account data

### Business Rules
- ACCOUNT_DATA_LOADING
- ACCOUNT_DATA_LOADING

### Parameters
| Name | Type | Default |
|------|------|---------|
| `path` | str | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: ACCOUNT_DATA_LOADING, ACCOUNT_DATA_LOADING*

---

## load_orders

### Signature
```python
def load_orders(path: str) -> DataFrame
```

### Description
Load order data from CSV file.
        
        BUSINESS_RULE: ORDER_DATA_LOADING
        Order data is loaded with schema validation. Only orders with status
        'COMPLETED' or 'PENDING' are considered for RAG calculations.
        Orders with status 'CANCELLED' are excluded from aggregations.
        
        Args:
            path: Path to orders CSV file
            
        Returns:
            DataFrame containing validated order data

### Business Rules
- ORDER_DATA_LOADING
- ORDER_DATA_LOADING

### Parameters
| Name | Type | Default |
|------|------|---------|
| `path` | str | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: ORDER_DATA_LOADING, ORDER_DATA_LOADING*

---

## load_transactions

### Signature
```python
def load_transactions(path: str) -> DataFrame
```

### Description
Load transaction data from CSV file.
        
        BUSINESS_RULE: TRANSACTION_DATA_LOADING
        Transaction data links payments to orders. Only transactions with
        status 'SUCCESS' are included in calculations.
        
        Args:
            path: Path to transactions CSV file
            
        Returns:
            DataFrame containing validated transaction data

### Business Rules
- TRANSACTION_DATA_LOADING
- TRANSACTION_DATA_LOADING

### Parameters
| Name | Type | Default |
|------|------|---------|
| `path` | str | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: TRANSACTION_DATA_LOADING, TRANSACTION_DATA_LOADING*

---

## join_orders_with_transactions

### Signature
```python
def join_orders_with_transactions(orders_df: DataFrame, transactions_df: DataFrame) -> DataFrame
```

### Description
Join orders with their associated transactions.
        
        BUSINESS_RULE: ORDER_TRANSACTION_JOIN
        Orders are joined with transactions to enrich order data with payment
        information. This is a left join to include orders without transactions.
        
        Args:
            orders_df: DataFrame containing orders
            transactions_df: DataFrame containing transactions
            
        Returns:
            DataFrame with orders enriched with transaction data

### Business Rules
- ORDER_TRANSACTION_JOIN
- ORDER_TRANSACTION_JOIN

### Parameters
| Name | Type | Default |
|------|------|---------|
| `orders_df` | DataFrame | - |
| `transactions_df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: ORDER_TRANSACTION_JOIN, ORDER_TRANSACTION_JOIN*

---

## create_customer_order_summary

### Signature
```python
def create_customer_order_summary(accounts_df: DataFrame, orders_df: DataFrame) -> DataFrame
```

### Description
Create a summary of orders per customer with account details.
        
        BUSINESS_RULE: CUSTOMER_ORDER_SUMMARY
        Aggregates all orders per customer and joins with account information
        to provide a complete view of customer ordering behavior.
        
        Args:
            accounts_df: DataFrame containing account data
            orders_df: DataFrame containing order data
            
        Returns:
            DataFrame with customer order summary

### Business Rules
- CUSTOMER_ORDER_SUMMARY
- CUSTOMER_ORDER_SUMMARY

### Parameters
| Name | Type | Default |
|------|------|---------|
| `accounts_df` | DataFrame | - |
| `orders_df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: CUSTOMER_ORDER_SUMMARY, CUSTOMER_ORDER_SUMMARY*

---

## run_rag_analysis

### Signature
```python
def run_rag_analysis(accounts_path: str, orders_path: str, transactions_path: str, target_month: str = None) -> DataFrame
```

### Description
Execute the complete RAG analysis pipeline.
        
        BUSINESS_RULE: RAG_ANALYSIS_EXECUTION
        The complete analysis pipeline:
        1. Loads all data sources with validation
        2. Filters out cancelled orders and failed transactions
        3. Calculates monthly aggregations
        4. Computes month-over-month changes
        5. Assigns RAG status based on defined thresholds
        6. Checks order limit violations
        
        RAG Thresholds:
        - RED: >= 50% increase from previous month
        - AMBER: >= 30% and < 50% increase from previous month
        - GREEN: < 30% increase from previous month
        
        Args:
            accounts_path: Path to accounts data
            orders_path: Path to orders data
            transactions_path: Path to transactions data
            target_month: Optional specific month to analyze
            
        Returns:
            DataFrame with RAG analysis results

### Business Rules
- RAG_ANALYSIS_EXECUTION
- RAG_ANALYSIS_EXECUTION

### Parameters
| Name | Type | Default |
|------|------|---------|
| `accounts_path` | str | - |
| `orders_path` | str | - |
| `transactions_path` | str | - |
| `target_month` | str | None |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: RAG_ANALYSIS_EXECUTION, RAG_ANALYSIS_EXECUTION*

---

## get_risk_summary

### Signature
```python
def get_risk_summary(rag_results: DataFrame) -> dict
```

### Description
Generate a summary of risk indicators from RAG results.
        
        BUSINESS_RULE: RISK_SUMMARY_GENERATION
        Provides aggregate counts of:
        - Accounts by RAG status (RED, AMBER, GREEN)
        - Accounts exceeding order limits
        - Total accounts analyzed
        
        Args:
            rag_results: DataFrame with RAG analysis results
            
        Returns:
            Dictionary containing risk summary metrics

### Business Rules
- RISK_SUMMARY_GENERATION
- RISK_SUMMARY_GENERATION

### Parameters
| Name | Type | Default |
|------|------|---------|
| `rag_results` | DataFrame | - |

### Returns
- `dict`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: RISK_SUMMARY_GENERATION, RISK_SUMMARY_GENERATION*

---
