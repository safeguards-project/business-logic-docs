# customer_orders_pipeline.py

**File:** `../source-code/src/pyspark/customer_orders_pipeline.py`

---

## load_accounts

### Signature
```python
def load_accounts(path: str) -> DataFrame
```

### Description
Load account data from CSV file.
        
        BUSINESS_RULE: ACCOUNT_DATA_LOADING
        Account data is loaded with schema validation. Accounts define customer
        information and their order_limit for validation.
        
        Args:
            path: Path to accounts CSV file
            
        Returns:
            DataFrame containing validated account data

### Business Rules
- ACCOUNT_DATA_LOADING
- ACCOUNT_DATA_LOADING

### Parameters
| Name | Type | Default |
|------|------|---------|
| `path` | str | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: ACCOUNT_DATA_LOADING, ACCOUNT_DATA_LOADING*

---

## load_orders

### Signature
```python
def load_orders(path: str) -> DataFrame
```

### Description
Load order data from CSV file.
        
        BUSINESS_RULE: ORDER_DATA_LOADING
        Order data is loaded with schema validation. Only orders with status
        'COMPLETED' or 'PENDING' are considered valid.
        Orders with status 'CANCELLED' are excluded from aggregations.
        
        Args:
            path: Path to orders CSV file
            
        Returns:
            DataFrame containing validated order data

### Business Rules
- ORDER_DATA_LOADING
- ORDER_DATA_LOADING

### Parameters
| Name | Type | Default |
|------|------|---------|
| `path` | str | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: ORDER_DATA_LOADING, ORDER_DATA_LOADING*

---

## load_transactions

### Signature
```python
def load_transactions(path: str) -> DataFrame
```

### Description
Load transaction data from CSV file.
        
        BUSINESS_RULE: TRANSACTION_DATA_LOADING
        Transaction data links payments to orders. Only transactions with
        status 'SUCCESS' are included in calculations.
        
        Args:
            path: Path to transactions CSV file
            
        Returns:
            DataFrame containing validated transaction data

### Business Rules
- TRANSACTION_DATA_LOADING
- TRANSACTION_DATA_LOADING

### Parameters
| Name | Type | Default |
|------|------|---------|
| `path` | str | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: TRANSACTION_DATA_LOADING, TRANSACTION_DATA_LOADING*

---

## join_orders_with_transactions

### Signature
```python
def join_orders_with_transactions(orders_df: DataFrame, transactions_df: DataFrame) -> DataFrame
```

### Description
Join orders with their associated transactions.
        
        BUSINESS_RULE: ORDER_TRANSACTION_JOIN
        Orders are joined with transactions to enrich order data with payment
        information. This is a left join to include orders without transactions.
        
        Args:
            orders_df: DataFrame containing orders
            transactions_df: DataFrame containing transactions
            
        Returns:
            DataFrame with orders enriched with transaction data

### Business Rules
- ORDER_TRANSACTION_JOIN
- ORDER_TRANSACTION_JOIN

### Parameters
| Name | Type | Default |
|------|------|---------|
| `orders_df` | DataFrame | - |
| `transactions_df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: ORDER_TRANSACTION_JOIN, ORDER_TRANSACTION_JOIN*

---

## run_pipeline

### Signature
```python
def run_pipeline(accounts_path: str, orders_path: str, transactions_path: str, target_month: str = None) -> PipelineOutput
```

### Description
Execute the complete orders processing pipeline.
        
        BUSINESS_RULE: PIPELINE_EXECUTION
        The complete pipeline:
        1. Loads all data sources with validation
        2. Filters out cancelled orders and failed transactions
        3. Calculates monthly aggregations
        4. Applies validation rules to split records
        5. Outputs result_table (valid) and holding_table (invalid records)
        
        BUSINESS_RULE: HOLDING_TABLE_ROUTING
        Records are routed to holding_table if they fail any validation rule:
        - MISSING_ACCOUNT_ID: account_id is null
        - MISSING_CUSTOMER_NAME: customer_name is null
        - NEGATIVE_AMOUNT: monthly_total < 0
        - INVALID_ORDER_COUNT: order_count <= 0
        - MISSING_ORDER_LIMIT: order_limit is null
        
        Args:
            accounts_path: Path to accounts data
            orders_path: Path to orders data
            transactions_path: Path to transactions data
            target_month: Optional specific month to analyze
            
        Returns:
            PipelineOutput with result_table and holding_table DataFrames

### Business Rules
- PIPELINE_EXECUTION
- HOLDING_TABLE_ROUTING
- PIPELINE_EXECUTION
- HOLDING_TABLE_ROUTING

### Parameters
| Name | Type | Default |
|------|------|---------|
| `accounts_path` | str | - |
| `orders_path` | str | - |
| `transactions_path` | str | - |
| `target_month` | str | None |

### Returns
- `PipelineOutput`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: PIPELINE_EXECUTION, HOLDING_TABLE_ROUTING, PIPELINE_EXECUTION, HOLDING_TABLE_ROUTING*

---

## get_result_summary

### Signature
```python
def get_result_summary(result_table: DataFrame) -> dict
```

### Description
Generate a summary of records in the result table.
        
        BUSINESS_RULE: RESULT_SUMMARY_GENERATION
        Provides aggregate metrics:
        - Total valid records
        - Total monthly amount
        - Total order count
        
        Args:
            result_table: DataFrame containing valid records
            
        Returns:
            Dictionary containing result summary metrics

### Business Rules
- RESULT_SUMMARY_GENERATION
- RESULT_SUMMARY_GENERATION

### Parameters
| Name | Type | Default |
|------|------|---------|
| `result_table` | DataFrame | - |

### Returns
- `dict`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: RESULT_SUMMARY_GENERATION, RESULT_SUMMARY_GENERATION*

---

## get_holding_summary

### Signature
```python
def get_holding_summary(holding_table: DataFrame) -> dict
```

### Description
Generate a summary of records in the holding table.
        
        BUSINESS_RULE: HOLDING_SUMMARY_GENERATION
        Provides aggregate counts of:
        - Total records held
        - Records by hold reason
        
        Args:
            holding_table: DataFrame containing held records
            
        Returns:
            Dictionary containing holding summary metrics

### Business Rules
- HOLDING_SUMMARY_GENERATION
- HOLDING_SUMMARY_GENERATION

### Parameters
| Name | Type | Default |
|------|------|---------|
| `holding_table` | DataFrame | - |

### Returns
- `dict`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: HOLDING_SUMMARY_GENERATION, HOLDING_SUMMARY_GENERATION*

---
