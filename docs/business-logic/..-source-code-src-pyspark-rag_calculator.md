# rag_calculator.py

**File:** `../source-code/src/pyspark/rag_calculator.py`

---

## calculate_monthly_totals

### Signature
```python
def calculate_monthly_totals(orders_df: DataFrame) -> DataFrame
```

### Description
Calculate monthly order totals per account.
        
        BUSINESS_RULE: MONTHLY_AGGREGATION
        Orders are aggregated by account_id and month to calculate:
        - Total order amount for the month
        - Total number of orders for the month
        - Total product count for the month
        
        Args:
            orders_df: DataFrame containing order data
            
        Returns:
            DataFrame with monthly totals per account

### Business Rules
- MONTHLY_AGGREGATION
- MONTHLY_AGGREGATION

### Parameters
| Name | Type | Default |
|------|------|---------|
| `orders_df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: MONTHLY_AGGREGATION, MONTHLY_AGGREGATION*

---

## calculate_month_over_month_change

### Signature
```python
def calculate_month_over_month_change(monthly_totals_df: DataFrame) -> DataFrame
```

### Description
Calculate the percentage change between current and previous month.
        
        BUSINESS_RULE: MOM_COMPARISON
        For each account, compare the current month's total against the previous month's total.
        The percentage change is calculated as: (current - previous) / previous * 100
        If previous month total is zero or null, the change is considered as null.
        
        Args:
            monthly_totals_df: DataFrame with monthly totals per account
            
        Returns:
            DataFrame with month-over-month percentage change

### Business Rules
- MOM_COMPARISON
- MOM_COMPARISON

### Parameters
| Name | Type | Default |
|------|------|---------|
| `monthly_totals_df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: MOM_COMPARISON, MOM_COMPARISON*

---

## determine_rag_status

### Signature
```python
def determine_rag_status(df: DataFrame) -> DataFrame
```

### Description
Determine RAG status based on percentage change thresholds.
        
        BUSINESS_RULE: RAG_STATUS_DETERMINATION
        RAG status is assigned based on the following rules:
        - RED: percentage_change >= 50% (significant increase requiring attention)
        - AMBER: percentage_change >= 30% and < 50% (moderate increase, monitor closely)
        - GREEN: percentage_change < 30% (acceptable change within normal bounds)
        - NULL/No previous data: Defaults to GREEN (new customers)
        
        Args:
            df: DataFrame with percentage_change column
            
        Returns:
            DataFrame with rag_status column added

### Business Rules
- RAG_STATUS_DETERMINATION
- RAG_STATUS_DETERMINATION

### Parameters
| Name | Type | Default |
|------|------|---------|
| `df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: RAG_STATUS_DETERMINATION, RAG_STATUS_DETERMINATION*

---

## check_order_limit

### Signature
```python
def check_order_limit(df: DataFrame, accounts_df: DataFrame) -> DataFrame
```

### Description
Check if customer has exceeded their monthly order limit.
        
        BUSINESS_RULE: ORDER_LIMIT_CHECK
        Each account has a defined order_limit (max orders per month).
        If the current month's order_count exceeds order_limit, flag as exceeded.
        This is an additional risk indicator independent of RAG status.
        
        Args:
            df: DataFrame with order counts
            accounts_df: DataFrame with account order limits
            
        Returns:
            DataFrame with limit_exceeded flag

### Business Rules
- ORDER_LIMIT_CHECK
- ORDER_LIMIT_CHECK

### Parameters
| Name | Type | Default |
|------|------|---------|
| `df` | DataFrame | - |
| `accounts_df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: ORDER_LIMIT_CHECK, ORDER_LIMIT_CHECK*

---

## calculate_rag

### Signature
```python
def calculate_rag(orders_df: DataFrame, accounts_df: DataFrame, target_month: str = None) -> DataFrame
```

### Description
Main method to calculate RAG status for all accounts.
        
        BUSINESS_RULE: RAG_CALCULATION_PIPELINE
        The complete RAG calculation follows these steps:
        1. Aggregate orders by month per account
        2. Calculate month-over-month percentage change
        3. Determine RAG status based on thresholds
        4. Check order limit violations
        5. Return final status for the target month (or latest month if not specified)
        
        Args:
            orders_df: DataFrame containing all orders
            accounts_df: DataFrame containing account information
            target_month: Optional target month in 'YYYY-MM-DD' format
            
        Returns:
            DataFrame with complete RAG analysis results

### Business Rules
- RAG_CALCULATION_PIPELINE
- RAG_CALCULATION_PIPELINE

### Parameters
| Name | Type | Default |
|------|------|---------|
| `orders_df` | DataFrame | - |
| `accounts_df` | DataFrame | - |
| `target_month` | str | None |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: RAG_CALCULATION_PIPELINE, RAG_CALCULATION_PIPELINE*

---
