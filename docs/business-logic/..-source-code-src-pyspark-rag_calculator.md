# rag_calculator.py

**File:** `../source-code/src/pyspark/rag_calculator.py`

---

## calculate_monthly_totals

### Signature
```python
def calculate_monthly_totals(orders_df: DataFrame) -> DataFrame
```

### Description
Calculate monthly order totals per account.
        
        BUSINESS_RULE: MONTHLY_AGGREGATION
        Orders are aggregated by account_id and month to calculate:
        - Total order amount for the month
        - Total number of orders for the month
        - Total product count for the month
        
        Args:
            orders_df: DataFrame containing order data
            
        Returns:
            DataFrame with monthly totals per account

### Business Rules
- MONTHLY_AGGREGATION
- MONTHLY_AGGREGATION

### Parameters
| Name | Type | Default |
|------|------|---------|
| `orders_df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: MONTHLY_AGGREGATION, MONTHLY_AGGREGATION*

---

## enrich_with_account_data

### Signature
```python
def enrich_with_account_data(monthly_totals_df: DataFrame, accounts_df: DataFrame) -> DataFrame
```

### Description
Enrich monthly totals with account information.
        
        BUSINESS_RULE: ACCOUNT_ENRICHMENT
        Monthly totals are joined with account data to include
        customer_name and order_limit for validation.
        
        Args:
            monthly_totals_df: DataFrame with monthly totals
            accounts_df: DataFrame with account information
            
        Returns:
            DataFrame enriched with account data

### Business Rules
- ACCOUNT_ENRICHMENT
- ACCOUNT_ENRICHMENT

### Parameters
| Name | Type | Default |
|------|------|---------|
| `monthly_totals_df` | DataFrame | - |
| `accounts_df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: ACCOUNT_ENRICHMENT, ACCOUNT_ENRICHMENT*

---

## apply_validation_rules

### Signature
```python
def apply_validation_rules(df: DataFrame) -> DataFrame
```

### Description
Apply validation rules and determine hold reasons.
        
        BUSINESS_RULE: VALIDATION_RULES
        Records are validated against the following rules:
        1. MISSING_CUSTOMER_NAME: customer_name must not be null
        2. NEGATIVE_AMOUNT: monthly_total must be >= 0
        3. INVALID_ORDER_COUNT: order_count must be > 0
        4. MISSING_ORDER_LIMIT: order_limit must not be null
        5. MISSING_ACCOUNT_ID: account_id must not be null
        
        Records failing any rule are routed to holding_table with the reason.
        
        Args:
            df: DataFrame with enriched order data
            
        Returns:
            DataFrame with validation_failed flag and hold_reason columns

### Business Rules
- VALIDATION_RULES
- VALIDATION_RULES

### Parameters
| Name | Type | Default |
|------|------|---------|
| `df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: VALIDATION_RULES, VALIDATION_RULES*

---

## split_by_validation

### Signature
```python
def split_by_validation(df: DataFrame) -> PipelineOutput
```

### Description
Split records into result_table and holding_table based on validation.
        
        BUSINESS_RULE: RECORD_ROUTING
        - result_table: Contains all records that pass validation rules
        - holding_table: Contains all records that fail validation rules with hold_reason
        
        Args:
            df: DataFrame with validation_failed and hold_reason columns
            
        Returns:
            PipelineOutput containing result_table and holding_table DataFrames

### Business Rules
- RECORD_ROUTING
- RECORD_ROUTING

### Parameters
| Name | Type | Default |
|------|------|---------|
| `df` | DataFrame | - |

### Returns
- `PipelineOutput`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: RECORD_ROUTING, RECORD_ROUTING*

---

## validate_orders

### Signature
```python
def validate_orders(orders_df: DataFrame, accounts_df: DataFrame, target_month: str = None) -> PipelineOutput
```

### Description
Main method to validate orders and split into result/holding tables.
        
        BUSINESS_RULE: VALIDATION_PIPELINE
        The complete validation pipeline follows these steps:
        1. Aggregate orders by month per account
        2. Enrich with account data
        3. Apply validation rules
        4. Split into result_table (valid) and holding_table (invalid)
        5. Return both outputs for the target month (or latest month if not specified)
        
        Args:
            orders_df: DataFrame containing all orders
            accounts_df: DataFrame containing account information
            target_month: Optional target month in 'YYYY-MM-DD' format
            
        Returns:
            PipelineOutput containing result_table and holding_table DataFrames

### Business Rules
- VALIDATION_PIPELINE
- VALIDATION_PIPELINE

### Parameters
| Name | Type | Default |
|------|------|---------|
| `orders_df` | DataFrame | - |
| `accounts_df` | DataFrame | - |
| `target_month` | str | None |

### Returns
- `PipelineOutput`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: VALIDATION_PIPELINE, VALIDATION_PIPELINE*

---

## calculate_customer_risk_score

### Signature
```python
def calculate_customer_risk_score(df: DataFrame) -> DataFrame
```

### Description
Calculate a risk score for each customer based on order patterns.
        
        BUSINESS_RULE: CUSTOMER_RISK_SCORING
        Risk score is calculated as follows:
        - Base score starts at 0
        - Add 20 points if order_count exceeds order_limit
        - Add 15 points if monthly_total exceeds 10000
        - Add 10 points for each validation failure
        - Customers with score >= 50 are flagged as HIGH_RISK
        - Customers with score 25-49 are flagged as MEDIUM_RISK
        - Customers with score < 25 are flagged as LOW_RISK
        
        Args:
            df: DataFrame with customer order data
            
        Returns:
            DataFrame with risk_score and risk_category columns added

### Business Rules
- CUSTOMER_RISK_SCORING
- CUSTOMER_RISK_SCORING

### Parameters
| Name | Type | Default |
|------|------|---------|
| `df` | DataFrame | - |

### Returns
- `DataFrame`

*Classification: business_logic (high confidence)*
*Reason: Contains BUSINESS_RULE markers: CUSTOMER_RISK_SCORING, CUSTOMER_RISK_SCORING*

---
